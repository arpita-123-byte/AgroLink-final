<!DOCTYPE html>
<html>
<head>
  <title>Live Chat - AgroLink</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #messages { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .msg { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Live Chat</h2>
  <div id="messages"></div>
  <input type="text" id="messageInput" placeholder="Type a message" />
  <button onclick="sendMessage()">Send</button>

  <script>
    const socket = io();
const username = localStorage.getItem("userEmail") || "Guest";
const role = localStorage.getItem("userRole") || "User";

const urlParams = new URLSearchParams(window.location.search);
const targetEmail = urlParams.get("target");

const roomId = [username, targetEmail].sort().join("-");
const chatMessages = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");

if (targetEmail) {
  socket.emit("joinRoom", { roomId });

  fetch(`/api/chat-history?roomId=${encodeURIComponent(roomId)}`)
    .then(res => res.json())
    .then(data => {
      data.forEach(msg => {
        const msgDiv = document.createElement("div");
        msgDiv.className = msg.sender === username ? "text-end text-success" : "text-start text-primary";
        msgDiv.textContent = `${msg.role}: ${msg.text}`;
        chatMessages.appendChild(msgDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

function sendMessage() {
  const text = messageInput.value.trim();
  if (!text) return;

  socket.emit("chatMessage", {
    sender: username,
    role,
    text
  });

  messageInput.value = "";
}

socket.on("chatMessage", (msg) => {
  const msgDiv = document.createElement("div");
  msgDiv.className = msg.sender === username ? "text-end text-success" : "text-start text-primary";
  msgDiv.textContent = `${msg.role}: ${msg.text}`;
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

  </script>
</body>
</html>
